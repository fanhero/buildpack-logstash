#!/bin/bash

indent() {
  sed -u 's/^/       /'
}

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

if [ -f "$ENV_DIR/DOWNLOAD_URL" ]; then
  DOWNLOAD_URL=$(cat $ENV_DIR/DOWNLOAD_URL)
else
  DOWNLOAD_URL="https://download.elastic.co/logstash/logstash/logstash-2.3.1.tar.gz"
fi

LOGSTASH_PACKAGE=${DOWNLOAD_URL##*/}

case ${LOGSTASH_PACKAGE} in
  *.tar.gz)
    LOGSTASH_DIR="$BUILD_DIR/${LOGSTASH_PACKAGE%%.tar.gz}"
    tar="tar xz"
    ;;
  *)
    echo "Only tar.gz is supported: $LOGSTASH_PACKAGE" | indent
    exit 1
    ;;
esac

mkdir="mkdir -p"
download="curl -sLO"
extract="$tar -C $BUILD_DIR --wildcards -f"
verify="sha1sum --check --warn"

echo "-----> Installing Logstash..."

$mkdir $CACHE_DIR

if [ ! -f "$CACHE_DIR/$LOGSTASH_PACKAGE" ]; then
  echo "downloading $DOWNLOAD_URL" | indent
  $download $DOWNLOAD_URL

  echo "verifying against ${DOWNLOAD_URL}.sha1.txt" | indent
  $download "${DOWNLOAD_URL}.sha1.txt"
  $verify "${LOGSTASH_PACKAGE}.sha1.txt"

  if [ $? -eq 0 ]; then
    mv $LOGSTASH_PACKAGE $CACHE_DIR
  else
    exit 1
  fi
fi

$extract $CACHE_DIR/$LOGSTASH_PACKAGE

if [ -f /etc/logstash/conf.d/fanhero.conf ]; then
    echo '-----> Found a Logstash configuration'
else
    echo 'No logstash configuration found.  Installing...' | indent
    curl -s 'https://raw.githubusercontent.com/fanhero/buildpack-logstash/master/fanhero.conf' | sudo tee /etc/logstash/conf.d/fanhero.conf > /dev/null
fi

# Actually turn it on
echo '-----> Starting Logstash with Fanhero config...'
sudo /opt/logstash/bin/logstash -f /etc/logstash/fanhero.conf

# echo "Exporting PATH" | indent
# echo 'export PATH="$PATH:'${LOGSTASH_DIR##*/}'/bin"' > $INIT_SCRIPT